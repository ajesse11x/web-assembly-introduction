<script>
  async function create(path, importObject) {
    const bytes = await window.fetch(path).then(x => x.arrayBuffer());
    return WebAssembly.instantiate(bytes, importObject);
  }

  const memory = new WebAssembly.Memory({initial: 256, maximum: 256});
  const env = {
    // 'ABORT': 0,
    // 'DYNAMICTOP_PTR': 2064,
    'STACKTOP': 0,
    'STACK_MAX': 5244960,
    'abortStackOverflow': _ => {
      throw new Error('overflow');
    },
    'tableBase': 0,
    'memoryBase': 1024,
    'table': new WebAssembly.Table({initial: 0, maximum: 0, element: "anyfunc"}),
    'memory': memory,
  };

  const buffer = new Uint8Array(memory.buffer);

  env['_print'] = arg => console.info('logging', arg);

  create('output.wasm', {env}).then(thing => {
    const o = thing.instance.exports;

    window.asm = o;
    draw();
  });


  function draw() {
    const dim = 100;  // TODO
    canvas.width = canvas.height = dim + 2;
    canvas.style.width = canvas.style.height = `${dim*5}px`;
    const data = new ImageData(canvas.width, canvas.height);

    const ref = asm._board_ref();

    for (var x = 1; x <= dim; ++x) {
      for (var y = 1; y <= dim; ++y) {

        var pos = (y * (dim + 2)) + x;
        var i = (pos / 8) << 0;
        var off = 1 << (pos % 8);

        var alive = (buffer[ref + i] & off);
        if (!alive) { continue; }

        const doff = (y * canvas.width + x) * 4;
        data.data[doff+0] = 255;
        data.data[doff+1] = 0;
        data.data[doff+2] = 0;
        data.data[doff+3] = 255;
      }
    }

    const context = canvas.getContext('2d');
    context.putImageData(data, 0, 0)
  }

  window.onload = ev => {
    let run = false;

    function steps() {
      window.requestAnimationFrame(function() {
        draw();
        const out = asm._board_step();
        if (out < 0) { return; }  // we're stable
        if (run) { steps(); }
      });
    }

    start.onclick = ev => {
      asm ._board_init();
      run = true;
      steps();
    };
    pp.onclick = ev => {
      run = !run;
      if (run) { steps(); }
    };
  };

</script>
<style>
  canvas {
    image-rendering: pixelated;
    border: 2px solid green;
  }
</style>

<canvas id="canvas">
</canvas>
<div>
<button id="start">Start</button>
<button id="pp">Play/Pause</button>
</div>